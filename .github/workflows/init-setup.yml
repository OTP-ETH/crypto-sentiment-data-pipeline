name: "Initial Setup"
on:
  workflow_dispatch:
    inputs:
      region:
        description: GCP region
        required: true
        default: "us-central1"
        type: string
      zone:
        description: Zone in the selected GCP region
        required: true
        default: "us-central1-a"
        type: string
      artifact_repository:
        description: Artifact Registry Repository
        required: true
        default: "prefect-agent-image"
        type: string
      machine_type:
        description: GCP Compute Engine instance type
        required: true
        default: "e2-micro"
        type: string
      machine_name:
        description: "GCP Compute Engine instance name"
        required: false
        default: "prefect-agent"
      gcp_creds_block_name:
        description: "GCP Credentials block name"
        required: false
        default: "default"
        type: string
      github_block_name:
        description: "GitHub block name"
        required: false
        default: "default"
        type: string
      cloudrun_block_name:
        description: "CloudRunJob block name"
        required: false
        default: "default"
        type: string
      deployment:
        description: "Prefect deployment name"
        required: false
        default: "default"
        type: string
      queue:
        description: "Prefect queue name"
        required: false
        default: "default"
        type: string
jobs:
  deploy-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: build-image
        name: Build Prefect agent docker image
        uses: ./.github/actions/build-image
        with:
          prefect_api_key: ${{ secrets.PREFECT_API_KEY }}
          prefect_api_url: ${{ secrets.PREFECT_API_URL }}
          artifact_repository: ${{ github.event.inputs.artifact_repository }}
          image_name: "deployments"
          region: ${{ github.event.inputs.region }}
          dockerfile_path: Dockerfile
          gcp_credentials_json: ${{ secrets.GCP_CREDENTIALS }}
      - id: deploy-vm
        name: Deploy Prefect agent
        uses: ./.github/actions/deploy-vm
        with:
          prefect_api_key: ${{ secrets.PREFECT_API_KEY }}
          prefect_api_url: ${{ secrets.PREFECT_API_URL }}
          region: ${{ github.event.inputs.region }}
          zone: ${{ github.event.inputs.zone }}
          machine_type: ${{ github.event.inputs.machine_type }}
          machine_name: ${{ github.event.inputs.machine_name }}
          gcp_credentials_json: ${{ secrets.GCP_CREDENTIALS }}

  create-blocks:
    runs-on: ubuntu-latest
    needs: deploy-agent
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: create-blocks
        name: Create Prefect blocks
        uses: ./.github/actions/create-blocks
        with:
          prefect_api_key: ${{ secrets.PREFECT_API_KEY }}
          prefect_api_url: ${{ secrets.PREFECT_API_URL }}
          gcp_creds_block_name: ${{ github.event.inputs.gcp_creds_block_name }}
          github_block_name: ${{ github.event.inputs.github_block_name }}
          cloudrun_block_name: ${{ github.event.inputs.cloudrun_block_name }}
          region: ${{ github.event.inputs.region }}
          gcp_credentials_json: ${{ secrets.GCP_CREDENTIALS }}
          artifact_repository: ${{ github.event.inputs.artifact_repository }}
          image_name: "deployments"
          python_version: "3.10"
          install_command: "pip install ."

  get-flows:
    runs-on: ubuntu-latest
    needs: create-blocks
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: set-matrix
        name: Collect Prefect flows
        run: echo "matrix=$(ls flows/*.py | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  build-deployment:
    needs: get-flows
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flows: ${{ fromJson(needs.get-flows.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: flow
        name: Build Prefect flows
        run: |
          export FLOW_NAME=$(basename ${{ matrix.flows }} .py)
          echo "entrypoint=${{ matrix.flows }}:$FLOW_NAME" >> $GITHUB_OUTPUT
      - id: deploy
        name: Setup Prefect deployment
        uses: ./.github/actions/deploy-flows
        with:
          prefect_api_key: ${{ secrets.PREFECT_API_KEY }}
          prefect_api_url: ${{ secrets.PREFECT_API_URL }}
          flow_entrypoint: ${{ steps.flow.outputs.entrypoint }}
          deployment: ${{ github.event.inputs.deployment }}
          queue: ${{ github.event.inputs.queue }}
          github_block_name: github/${{ github.event.inputs.github_block_name }}
          cloudrun_block_name: cloud-run-job/${{ github.event.inputs.cloudrun_block_name }}
          gcp_credentials_json: ${{ secrets.GCP_CREDENTIALS }}
          python_version: "3.10"
          install_command: "pip install ."

  setup_gcp:
    name: Setup GCP services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: infra
        name: Setup infrastructure
        uses: ./.github/actions/setup-infra
      - id: superset
        name: Setup Superset
        uses: ./.github/actions/setup-superset

